<html>
<head>
    <title>Mutiplayer Game</title>
</head>
<body>
    <canvas id="ctx" width="500" height="500" style="border: 1px solid #000000"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script>
        var ctx = document.getElementById("ctx").getContext("2d");
        var WIDTH = 500;
        var HEIGHT = 500;
        ctx.font = '20px Arial';

        var socket = io();
        var random = Math.random();
        var player_id = 0;

        socket.on('player_id', function(id) {
            player_id = id;
        });

        var me = {};

        socket.on('newpositions', function(data) {
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            for (var i = 0; i < data.players.length; ++i) {
                ctx.fillText(data.players[i].number, data.players[i].x, data.players[i].y);
                if (data.players[i].id == player_id) {
                    me = data.players[i];
                }
            }
            for (var i = 0; i < data.bullets.length; ++i) {
                ctx.fillRect(data.bullets[i].x - 5, data.bullets[i].y - 5, 10, 10);
            }
        });

        document.onkeydown = function(evt) {
            switch (evt.keyCode) {
                case 87:
                    socket.emit('keyPress', {inputId: 'up', state: true});
                    break;
                case 83:
                    socket.emit('keyPress', {inputId: 'down', state: true});
                    break;
                case 65:
                    socket.emit('keyPress', {inputId: 'left', state: true});
                    break;
                case 68:
                    socket.emit('keyPress', {inputId: 'right', state: true});
                    break;
            }
        }

        document.onkeyup = function(evt) {
            switch (evt.keyCode) {
                case 87:
                    socket.emit('keyPress', {inputId: 'up', state: false});
                    break;
                case 83:
                    socket.emit('keyPress', {inputId: 'down', state: false});
                    break;
                case 65:
                    socket.emit('keyPress', {inputId: 'left', state: false});
                    break;
                case 68:
                    socket.emit('keyPress', {inputId: 'right', state: false});
                    break;
            }
        }

        document.onclick = function(evt) {
            var x = evt.clientX - me.x - 15;
            var y = evt.clientY - me.y + 10;
            var radius = Math.sqrt(x * x + y * y);
            var angle = Math.acos(x / radius) * 180 / Math.PI;

            if (y < 0) {
                angle = 360 - angle;
            }

            socket.emit('fire', {
                x: me.x + 10,
                y: me.y - 10,
                angle: angle
            });
        }
    </script>
</body>
</html>